#!/bin/bash

if [ -d "/app" ]; then
    cp -r /app/js/ /var/www/html/public
    cp -r /app/php /var/www/html
    cp -r /app/styl /var/www/html/public
    rm -rf /app
fi

if [ ! -d "var" ]; then
    mkdir var
fi

if [ ! -f "var/log" ]; then
    mkfifo var/log
    chmod go+rw var/log
fi

if [ ! -f "var/telemetry" ]; then
    mkfifo var/telemetry
    chmod go+rw var/telemetry
fi

tail -f var/log&

if [ "$BASIS_ENVIRONMENT" != "dev" ]; then
    ./composer.phar dump-autoload --classmap-authoritative
else
    ./composer.phar dump-autoload
fi

./loop php console module.process job=module.telemetry iterations=1024&

php console module.bootstrap

if [ -f "php/Job/Background.php" ]; then
    ./loop php console module.process job=module.background iterations=1024&
fi

if [ "$SERVICE_EXECUTOR" != "false" ]; then
    ./loop php console module.process job=module.execute iterations=1024&
fi

apache2-foreground > /dev/null